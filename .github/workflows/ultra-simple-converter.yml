name: Convert PowerPoint to PDF and Images

on:
  push:
    paths:
      - 'source/*.pptx'
      - 'source/*.ppt'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install LibreOffice
      run: |
        sudo apt-get update
        sudo apt-get install -y libreoffice

    - name: Install ImageMagick and configure
      run: |
        sudo apt-get install -y imagemagick
        # PDFå¤‰æ›ã®ãŸã‚ã®ãƒãƒªã‚·ãƒ¼è¨­å®š
        if [ -f /etc/ImageMagick-6/policy.xml ]; then
          sudo sed -i 's/rights="none" pattern="PDF"/rights="read|write" pattern="PDF"/' /etc/ImageMagick-6/policy.xml
        elif [ -f /etc/ImageMagick-7/policy.xml ]; then
          sudo sed -i 's/rights="none" pattern="PDF"/rights="read|write" pattern="PDF"/' /etc/ImageMagick-7/policy.xml
        fi

    - name: Convert PPTX to PDF
      run: |
        mkdir -p output
        for file in source/*.ppt*; do
          if [ -f "$file" ]; then
            echo "Converting: $file"
            libreoffice --headless --convert-to pdf --outdir output "$file"
          fi
        done

    - name: Convert PDF to PNG images
      run: |
        mkdir -p docs/output/slides
        for pdf in output/*.pdf; do
          if [ -f "$pdf" ]; then
            filename=$(basename "$pdf" .pdf)
            echo "Creating slides for: $pdf"
            convert -density 150 "$pdf" -quality 90 "docs/output/slides/${filename}-%02d.png"
          fi
        done

    - name: Copy PDFs to docs/output/
      run: |
        mkdir -p docs/output
        cp output/*.pdf docs/output/ || true

    - name: Create SlideShare-style viewer
      run: |
        mkdir -p docs
        cat > docs/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="ja">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ - SlideShareé¢¨ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼</title>
            <style>
                /* ...ï¼ˆçœç•¥ï¼šCSSéƒ¨åˆ†ã¯å…ƒã®ã‚‚ã®ã‚’æµç”¨ã—ã¦ãã ã•ã„ï¼‰... */
            </style>
        </head>
        <body>
            <div class="header">
                <div class="header-content">
                    <div class="logo">ğŸ“Š SlideViewer</div>
                    <div class="header-info">
                        æœ€çµ‚æ›´æ–°: <span id="timestamp"></span>
                    </div>
                </div>
            </div>

            <div class="container">
                <div id="presentations"></div>
            </div>

            <script>
                class SlideViewer {
                    /* ...ï¼ˆçœç•¥ï¼šå…ƒã®JavaScriptã‚’ãã®ã¾ã¾è²¼ã£ã¦ãã ã•ã„ï¼‰... */
                }
                // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¨­å®š
                document.getElementById('timestamp').textContent = new Date().toLocaleString('ja-JP', {
                    timeZone: 'Asia/Tokyo',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                // ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å‹•çš„ã«ç”Ÿæˆ
                const presentations = [];
        EOF

        for pdf in docs/output/*.pdf; do
          if [ -f "$pdf" ]; then
            filename=$(basename "$pdf" .pdf)
            echo "                presentations.push({" >> docs/index.html
            echo "                    name: '$filename'," >> docs/index.html
            echo "                    pdfUrl: 'output/${filename}.pdf'," >> docs/index.html
            echo -n "                    slides: [" >> docs/index.html
            first=true
            for img in docs/output/slides/${filename}-*.png; do
              if [ -f "$img" ]; then
                imgname=$(basename "$img")
                if [ "$first" = true ]; then
                  first=false
                else
                  echo -n "," >> docs/index.html
                fi
                echo -n "'output/slides/$imgname'" >> docs/index.html
              fi
            done
            echo "]" >> docs/index.html
            echo "                });" >> docs/index.html
          fi
        done

        cat >> docs/index.html << 'EOF'

                const container = document.getElementById('presentations');
                presentations.forEach((presentation, index) => {
                    /* ...ï¼ˆçœç•¥ï¼šå…ƒã®JavaScriptã‚’ãã®ã¾ã¾è²¼ã£ã¦ãã ã•ã„ï¼‰... */
                });

                if (presentations.length === 0) {
                    container.innerHTML = `
                        <div class="presentation-card">
                            <div class="presentation-header">
                                <h2 class="presentation-title">ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</h2>
                                <p style="margin-top: 15px; color: #666;">
                                    <code>source/</code> ãƒ•ã‚©ãƒ«ãƒ€ã«PowerPointãƒ•ã‚¡ã‚¤ãƒ«(.pptx)ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚<br>
                                    è‡ªå‹•çš„ã«å¤‰æ›ã•ã‚Œã¦ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
                                </p>
                            </div>
                        </div>
                    `;
                }
            </script>
        </body>
        </html>
        EOF

    - name: Update README
      run: |
        cat > README.md << 'EOF'
        # ğŸ“Š SlideShareé¢¨ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼

        PowerPointãƒ•ã‚¡ã‚¤ãƒ«ãŒè‡ªå‹•çš„ã«SlideShareé¢¨ã®ç¾ã—ã„Webãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã«å¤‰æ›ã•ã‚Œã¾ã™ã€‚

        ## ğŸŒ ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’è¦‹ã‚‹
        [**ğŸ¯ SlideShareé¢¨ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã‚’é–‹ã**](https://$(echo $GITHUB_REPOSITORY | cut -d'/' -f1).github.io/$(echo $GITHUB_REPOSITORY | cut -d'/' -f2)/)

        ## âœ¨ ä¸»ãªæ©Ÿèƒ½
        - ğŸ“± **ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³** - PCãƒ»ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒ»ã‚¹ãƒãƒ›å¯¾å¿œ
        - ğŸ–¼ï¸ **ã‚µãƒ ãƒã‚¤ãƒ«ä¸€è¦§** - å…¨ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ä¸€è¦§è¡¨ç¤º
        - âŒ¨ï¸ **ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³** - â†â†’ã‚­ãƒ¼ã§ã‚¹ãƒ©ã‚¤ãƒ‰é€ã‚Š
        - ğŸ” **ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒ¢ãƒ¼ãƒ‰** - ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
        - ğŸ“Š **ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼** - é€²è¡ŒçŠ¶æ³ã‚’è¦–è¦šåŒ–
        - ğŸ’¾ **PDFãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰** - å…ƒãƒ•ã‚¡ã‚¤ãƒ«ã®å–å¾—

        ## ğŸ¨ ãƒ‡ã‚¶ã‚¤ãƒ³ã®ç‰¹å¾´
        - ç¾ä»£çš„ãªã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³èƒŒæ™¯
        - ã‚¬ãƒ©ã‚¹ãƒ¢ãƒ¼ãƒ•ã‚£ã‚ºãƒ åŠ¹æœ
        - SlideShareé¢¨ã®æ´—ç·´ã•ã‚ŒãŸUI
        - ã‚¹ãƒ ãƒ¼ã‚ºãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        - ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªè¦‹ãŸç›®

        ## ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ
        ```
        â”œâ”€â”€ source/          # PowerPointãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®
        â”‚   â””â”€â”€ *.pptx      # ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«
        â”œâ”€â”€ docs/
        â”‚   â”œâ”€â”€ index.html  # ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸
        â”‚   â””â”€â”€ output/
        â”‚       â”œâ”€â”€ *.pdf   # PDFç‰ˆ
        â”‚       â””â”€â”€ slides/ # ã‚¹ãƒ©ã‚¤ãƒ‰ç”»åƒ
        â””â”€â”€ README.md
        ```

        ## ğŸ”§ ä½¿ç”¨æ–¹æ³•
        1. **ğŸ“¤ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰**: `source/`ãƒ•ã‚©ãƒ«ãƒ€ã«PowerPointãƒ•ã‚¡ã‚¤ãƒ«(.pptx)ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        2. **âš¡ è‡ªå‹•å¤‰æ›**: GitHub ActionsãŒè‡ªå‹•çš„ã«å¤‰æ›ã‚’é–‹å§‹
        3. **ğŸŒ å…¬é–‹**: GitHub Pagesã§SlideShareé¢¨ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ãŒå…¬é–‹
        4. **ğŸ‘€ é–²è¦§**: ç¾ã—ã„Webã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’é–²è¦§

        ## ğŸ¯ æ“ä½œæ–¹æ³•
        ### åŸºæœ¬æ“ä½œ
        - **â† â†’ ãƒœã‚¿ãƒ³**: ã‚¹ãƒ©ã‚¤ãƒ‰é€ã‚Š
        - **ã‚µãƒ ãƒã‚¤ãƒ«**: ã‚¯ãƒªãƒƒã‚¯ã§ä»»æ„ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã«ã‚¸ãƒ£ãƒ³ãƒ—
        - **ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒœã‚¿ãƒ³**: ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰
        - **PDFãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**: å…ƒãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

        ### ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        - **â† / â†’ ã‚­ãƒ¼**: ã‚¹ãƒ©ã‚¤ãƒ‰é€ã‚Šï¼ˆãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³æ™‚ï¼‰
        - **Esc ã‚­ãƒ¼**: ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³çµ‚äº†

        ## ğŸ“¥ ç›´æ¥ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        EOF

        for pdf in docs/output/*.pdf; do
          if [ -f "$pdf" ]; then
            filename=$(basename "$pdf")
            echo "- [${filename}](docs/output/${filename})" >> README.md
          fi
        done

        echo "" >> README.md
        echo "## ğŸ•’ æœ€çµ‚æ›´æ–°" >> README.md
        echo "$(date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')" >> README.md

    - name: Setup Pages
      uses: actions/configure-pages@v4

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './docs'

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        git commit -m "ğŸ”„ Auto-convert PowerPoint slides [$(date '+%Y-%m-%d %H:%M:%S')]" || exit 0
        git push
