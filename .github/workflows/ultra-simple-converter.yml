name: Ultra Simple PowerPoint Converter

on:
  push:
    paths: ['source/*.pptx', 'source/*.ppt']
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Debug - Check files
        run: |
          echo "=== Repository structure ==="
          find . -type f -name "*.pptx" -o -name "*.ppt" | head -10

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y libreoffice imagemagick
          sudo sed -i 's/rights="none" pattern="PDF"/rights="read|write" pattern="PDF"/g' /etc/ImageMagick-6/policy.xml

      - name: Convert files
        run: |
          mkdir -p output docs/output/slides

          converted=false
          for file in source/*.pptx source/*.ppt; do
            if [ -f "$file" ]; then
              echo "Converting: $file"
              libreoffice --headless --convert-to pdf --outdir output "$file"
              converted=true
            fi
          done

          if [ "$converted" = false ]; then
            echo "No PowerPoint files found!"
            exit 1
          fi

          for pdf in output/*.pdf; do
            if [ -f "$pdf" ]; then
              filename=$(basename "$pdf" .pdf)
              echo "Creating images for: $filename"
              convert -density 150 "$pdf" "output/slides/${filename}-%02d.png" || echo "Image conversion failed for $pdf"
            fi
          done

          cp -r output docs/ 2>/dev/null || echo "Copy completed with warnings"

      - name: Create HTML viewer
        run: |
          echo '<!DOCTYPE html>' > docs/index.html
          echo '<html lang="ja">' >> docs/index.html
          echo '<head>' >> docs/index.html
          echo '    <meta charset="UTF-8">' >> docs/index.html
          echo '    <meta name="viewport" content="width=device-width, initial-scale=1.0">' >> docs/index.html
          echo '    <title>スライドビューアー</title>' >> docs/index.html
          echo '    <style>' >> docs/index.html
          echo '        body { font-family: sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background: #f5f5f5; }' >> docs/index.html
          echo '        .card { background: white; border-radius: 10px; padding: 30px; margin: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }' >> docs/index.html
          echo '        .title { font-size: 24px; font-weight: bold; color: #333; margin-bottom: 20px; }' >> docs/index.html
          echo '        .download { background: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block; margin: 10px 0; }' >> docs/index.html
          echo '        .download:hover { background: #0056b3; }' >> docs/index.html
          echo '        .slide-container { text-align: center; margin: 20px 0; }' >> docs/index.html
          echo '        .slide-img { max-width: 100%; max-height: 600px; border: 1px solid #ddd; border-radius: 5px; margin: 10px; }' >> docs/index.html
          echo '        .nav { text-align: center; margin: 20px 0; }' >> docs/index.html
          echo '        .btn { background: #28a745; color: white; border: none; padding: 10px 20px; margin: 0 5px; border-radius: 5px; cursor: pointer; }' >> docs/index.html
          echo '        .btn:hover { background: #1e7e34; }' >> docs/index.html
          echo '        .btn:disabled { background: #ccc; cursor: not-allowed; }' >> docs/index.html
          echo '        .counter { text-align: center; color: #666; margin: 10px 0; }' >> docs/index.html
          echo '        .thumbnails { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin: 20px 0; }' >> docs/index.html
          echo '        .thumb { width: 80px; height: 60px; border: 2px solid #ddd; border-radius: 3px; cursor: pointer; }' >> docs/index.html
          echo '        .thumb:hover, .thumb.active { border-color: #007bff; }' >> docs/index.html
          echo '        .error { background: #f8d7da; color: #721c24; padding: 20px; border-radius: 5px; text-align: center; }' >> docs/index.html
          echo '    </style>' >> docs/index.html
          echo '</head>' >> docs/index.html
          echo '<body>' >> docs/index.html
          echo '    <div class="card">' >> docs/index.html
          echo '        <h1 class="title">📊 プレゼンテーションビューアー</h1>' >> docs/index.html
          echo '        <div id="content">Loading...</div>' >> docs/index.html
          echo '    </div>' >> docs/index.html
          echo '    <script>' >> docs/index.html
          echo '      document.getElementById("content").innerHTML = "<div class=\"error\"><h3>⚠️ プレゼンテーションが見つかりません</h3><p>source/ フォルダにPowerPointファイルをアップロードして、GitHub Actionsを実行してください。</p></div>";' >> docs/index.html
          echo '    </script>' >> docs/index.html
          echo '</body>' >> docs/index.html
          echo '</html>' >> docs/index.html

      - uses: actions/configure-pages@v4
      - uses: actions/upload-pages-artifact@v3
        with:
          path: './docs'
      - uses: actions/deploy-pages@v4

      - name: Commit
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add . || echo "Nothing to add"
          git commit -m "Convert slides $(date)" || echo "Nothing to commit"
          git push || echo "Nothing to push"
